<%- contentFor('body') %>
<main class="container mt-3">
  <div class="row">
    <div class="col-12">
      <div class="row">
        <h3 class="text-center text-white">Black Desert Online RU</h3>
        <p class="text-center">
          <a class="btn btn-outline-light mx-1" href="/day" role="button">День</a><a
            class="btn btn-outline-light mx-1" href="/month" role="button">Месяц</a>
        </p>
        <div class="col-12 col-md-4 my-auto">
          <div class="row">
            <div class="col-12 mt-4">
              <h4 class="text-white">Сервисы:</h4>
            </div>
            <div class="col-12">
              Авторизация: <span class="badge bg-secondary" id="auth_status">ожидание...</span>
            </div>
            <div class="col-12">
              Аукцион: <span class="badge bg-secondary" id="market_status">ожидание...</span>
            </div>
            <div class="col-12 mt-4">
              <h4 class="text-white">Игра:</h4>
            </div>
            <div class="col-12">
              Кальфеон-1: <span class="badge bg-secondary" id="k1_status">ожидание...</span>
            </div>
            <div class="col-12">
              Валенсия-1: <span class="badge bg-secondary" id="v1_status">ожидание...</span>
            </div>
            <div class="col-12">
              Медия-1: <span class="badge bg-secondary" id="m1_status">ожидание...</span>
            </div>
            <div class="col-12">
              Камасильвия-1: <span class="badge bg-secondary" id="kam1_status">ожидание...</span>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-8 mb-3">
          <div class="row">
            <div class="col-auto ms-auto">
              <select class="form-select form-select-sm bg-dark text-white" id="select_data">
                <option value="auth" selected>Авторизация</option>
                <option value="market">Аукцион</option>
                <option value="k1">Кальфеон-1</option>
                <option value="v1">Валенсия-1</option>
                <option value="m1">Медия-1</option>
                <option value="kam1">Камасильвия-1</option>
              </select>
            </div>
            <div class="col-12">
              <canvas id="chart"></canvas>
            </div>
          </div>
        </div>
        <hr class="text-muted">
        <div class="col-12 p-0" id="news"></div>
        <div class="col-12 mb-3">
          <div class="row">
            <div class="col mx-start">
              <a href="https://github.com/exi66/bdo-servers-status" style="text-decoration: none;">
                <svg aria-hidden="true" height="24" viewBox="0 0 16 16" version="1.1" width="24"
                  data-view-component="true" style="fill: #6c757d">
                  <path fill-rule="evenodd"
                    d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
                  </path>
                </svg>
                <small class="text-muted">by exi66</small>
              </a>
            </div>
            <div class="col mx-end text-end">
              <small id="update_time" class="text-muted"></small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>
<script>
  const timeout = 10000;
  document.addEventListener('DOMContentLoaded', function (event) {
    var chart = createDayChart('chart');
    updChart(chart, $('#select_data').find(':selected').val());
    updateStatus();
    updateNews();
    $('#select_data').on('change', function (e) {
      updChart(chart, this.value);
    });
    var checkStatus = setInterval(function () {
      updateStatus();
      updChart(chart, $('#select_data').find(':selected').val());
    }, timeout);
  });
  function updChart(chart, data) {
    let localDate = new Date();
    updateChart(`/chart/${localDate.getFullYear()}/${localDate.getMonth() + 1}/${localDate.getDate()}.json`, data, chart);
  }
  function updateNews() {
    var json = getData('/api/news');

    if (json.error) return console.error(json.error);

    $('#news').empty();
    for (let i = 0; i < Math.min(3, json.length); i++) {
      let text = json[i].text.split(' ').slice(1, -1).join(' ');
      let date = json[i].text.split(' ').slice(-1).toString();
      $('#news').append(
        $('<a/>')
          .addClass('row link-unstyled mx-3')
          .attr('href', json[i].url)
          .append(
            $('<div/>')
              .addClass('col-2 my-auto p-0')
              .append(
                $('<img/>')
                  .attr('src', json[i].img)
                  .addClass('img-fluid')
              )
          ).append(
            $('<div/>')
              .addClass('col mx-auto my-auto')
              .html(text)
          ).append(
            $('<div/>')
              .addClass('col-2 text-end my-auto d-none d-lg-block')
              .text(date.split('\/').join('.'))
          )
      ).append(
        $('<hr>')
          .addClass('text-muted')
      );
    }
  }
  function updateStatus() {
    var market = $('#market_status');
      auth = $('#auth_status'),
      k1 = $('#k1_status'),
      v1 = $('#v1_status'),
      m1 = $('#m1_status'),
      kam1 = $('#kam1_status'),
      time = $('#update_time'),
      json = getData('/api/status');

    if (json.error === 'maintenance') {
      market.removeClass('bg-secondary bg-danger bg-success bg-warning').addClass('bg-secondary');
      market.html('тех. работы');

      auth.removeClass('bg-secondary bg-danger bg-success bg-warning').addClass('bg-secondary');
      auth.html('тех. работы');

      k1.removeClass('bg-secondary bg-danger bg-success bg-warning').addClass('bg-secondary');
      k1.html('тех. работы');

      v1.removeClass('bg-secondary bg-danger bg-success bg-warning').addClass('bg-secondary');
      v1.html('тех. работы');

      m1.removeClass('bg-secondary bg-danger bg-success bg-warning').addClass('bg-secondary');
      m1.html('тех. работы');

      kam1.removeClass('bg-secondary bg-danger bg-success bg-warning').addClass('bg-secondary');
      kam1.html('тех. работы');
    }
    if (json.error) return console.error(json.error);

    time.html(new Date(json.time).toLocaleString());

    if (!json.market || !json.auth || !json.k1 || !json.v1 || !json.m1 || !json.kam1) return;

    market.removeClass('bg-secondary bg-danger bg-success bg-warning').addClass(
      json.market === -1 ? 'bg-danger' : json.market > 100 ? 'bg-warning' : 'bg-success'
    );
    market.html(json.market === -1 ? 'down' : json.market.toFixed(2) + 'ms');

    auth.removeClass('bg-secondary bg-danger bg-success bg-warning').addClass(
      json.auth === -1 ? 'bg-danger' : json.auth > 100 ? 'bg-warning' : 'bg-success'
    );
    auth.html(json.auth === -1 ? 'down' : json.auth.toFixed(2) + 'ms');

    k1.removeClass('bg-secondary bg-danger bg-success bg-warning').addClass(
      json.k1 === -1 ? 'bg-danger' : json.k1 > 100 ? 'bg-warning' : 'bg-success'
    );
    k1.html(json.k1 === -1 ? 'down' : json.k1.toFixed(2) + 'ms');

    v1.removeClass('bg-secondary bg-danger bg-success bg-warning').addClass(
      json.v1 === -1 ? 'bg-danger' : json.v1 > 100 ? 'bg-warning' : 'bg-success'
    );
    v1.html(json.v1 === -1 ? 'down' : json.v1.toFixed(2) + 'ms');

    m1.removeClass('bg-secondary bg-danger bg-success bg-warning').addClass(
      json.m1 === -1 ? 'bg-danger' : json.m1 > 100 ? 'bg-warning' : 'bg-success'
    );
    m1.html(json.m1 === -1 ? 'down' : json.m1.toFixed(2) + 'ms');

    kam1.removeClass('bg-secondary bg-danger bg-success bg-warning').addClass(
      json.kam1 === -1 ? 'bg-danger' : json.kam1 > 100 ? 'bg-warning' : 'bg-success'
    );
    kam1.html(json.kam1 === -1 ? 'down' : json.kam1.toFixed(2) + 'ms');
  }
</script>
<%- contentFor('og-title') %>
Главная
<%- contentFor('title') %>
Главная
<%- contentFor('large_image') %>
/img/today.png
<%- contentFor('script') %>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="/js/main.js"></script>
